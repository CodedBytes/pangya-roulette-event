<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pangya Roulette!</title>
    <link rel="stylesheet" href="./game.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>
<body >
    <main>
        <audio id="bgm_teatime" controls muted src="./sfx/teatime.mp3" style="display: none;"></audio>
        <div class="game-page">
            <div class="game-container">
                <img src="./imgs/logo.png" alt="" title="PangYa Premiun Jackpot" width="400px">
                <div class="out-circle">
                    <button id="mute_unmute" class="mute_unmute"><i class="fa-solid fa-volume-xmark"></i></button>
                </div><!-- Sound Button -->

                <div class="qty-container">
                    <img src="./imgs/item1_48.png" alt="" width="55px">
                    <div class="numbers-container">
                        <span class="qty">0</span>
                    </div>
                </div><!-- Container showing how many game tickets the user have -->

                <div class="roulette-section">
                    <div class="title">
                        <span>Roleta</span>
                    </div>

                    <div class="r-container">
                        <div class="sub-container">
                            <div class="square">
                                <div id="itemBox"><img src="./imgs/Curvemastery.webp" alt="" width="45px"></div>
                            </div>
                        </div>
    
                        <button type="button" id="start" onclick="roulette();" >Start Game</button>
                    </div>
                </div><!-- Roulette item section -->

                <div class="items-section">
                    <div class="title">
                        <span>Items</span>
                    </div>

                    <div class="items-container">
                        <div class="item-frame">
                            <span>Curve Mastery</span>

                            <div class="out-frame">
                                <div class="in-frame">
                                    <img src="./imgs/Curvemastery.webp" alt="" width="30px">
                                </div>
                            </div><!-- Item frame -->
                            <div class="prob-bar">
                                <div class="prob" style='width: <%= itens[0].probabilidade %>%; background-color: blue; border-radius: 1rem;'></div>
                            </div><!-- Probability bar -->
                            <span class="bar-name">Qtde</span>
                            <span class="qty">x5</span>
                        </div><!-- item -->
                        
                        <div class="item-frame">
                            <span>Duostar L.S</span>

                            <div class="out-frame">
                                <div class="in-frame">
                                    <img src="./imgs/Duostarls.webp" alt="" width="30px">
                                </div>
                            </div><!-- Item frame -->
                            <div class="prob-bar">
                                <div class="prob" style='width: <%= itens[1].probabilidade %>%; background-color: blue; border-radius: 1rem;'></div>
                            </div><!-- Probability bar -->
                            <span class="bar-name">Qtde</span>
                            <span class="qty">x5</span>
                        </div><!-- item -->
                        
                        <div class="item-frame">
                            <span>Duostar L.P</span>

                            <div class="out-frame">
                                <div class="in-frame">
                                    <img src="./imgs/Duostarluckypangya.webp" alt="" width="30px">
                                </div>
                            </div><!-- Item frame -->
                            <div class="prob-bar">
                                <div class="prob" style='width: <%= itens[2].probabilidade %>%; background-color: blue; border-radius: 1rem;'></div>
                            </div><!-- Probability bar -->
                            <span class="bar-name">Qtde</span>
                            <span class="qty">x5</span>
                        </div><!-- item -->
                        
                        <div class="item-frame">
                            <span>Power Potion</span>

                            <div class="out-frame">
                                <div class="in-frame">
                                    <img src="./imgs/Powerpotion.webp" alt="" width="30px">
                                </div>
                            </div><!-- Item frame -->
                            <div class="prob-bar">
                                <div class="prob" style='width: <%= itens[3].probabilidade %>%; background-color: blue; border-radius: 1rem;'></div>
                            </div><!-- Probability bar -->
                            <span class="bar-name">Qtde</span>
                            <span class="qty">x5</span>
                        </div><!-- item -->
                        
                        <div class="item-frame">
                            <span>Angel Earing(A)</span>

                            <div class="out-frame">
                                <div class="in-frame">
                                    <img src="./imgs/g_earing_02.png" alt="" width="30px">
                                </div>
                            </div><!-- Item frame -->
                            <div class="prob-bar">
                                <div class="prob" style='width: <%= itens[4].probabilidade %>%; background-color: blue; border-radius: 1rem;'></div>
                            </div><!-- Probability bar -->
                            <span class="bar-name">Qtde</span>
                            <span class="qty">x1</span>
                        </div><!-- item -->
                        
                        <div class="item-frame">
                            <span>Water Aztec</span>

                            <div class="out-frame">
                                <div class="in-frame">
                                    <img src="./imgs/ball_128.png" alt="" width="30px">
                                </div>
                            </div><!-- Item frame -->
                            <div class="prob-bar">
                                <div class="prob" style='width: <%= itens[5].probabilidade %>%; background-color: blue; border-radius: 1rem;'></div>
                            </div><!-- Probability bar -->
                            <span class="bar-name">Qtde</span>
                            <span class="qty">x3</span>
                        </div><!-- item -->
                        
                        <div class="item-frame">
                            <span>Game Ticket</span>

                            <div class="out-frame">
                                <div class="in-frame">
                                    <img src="./imgs/item1_48.png" alt="" width="30px">
                                </div>
                            </div><!-- Item frame -->
                            <div class="prob-bar">
                                <div class="prob" style='width: <%= itens[6].probabilidade %>%; background-color: blue; border-radius: 1rem;'></div>
                            </div><!-- Probability bar -->
                            <span class="bar-name">Qtde</span>
                            <span class="qty">x1</span>
                        </div><!-- item -->
                        
                        <div class="item-frame">
                            <span>Card Remover</span>

                            <div class="out-frame">
                                <div class="in-frame">
                                    <img src="./imgs/removedor.png" alt="" width="30px">
                                </div>
                            </div><!-- Item frame -->
                            <div class="prob-bar">
                                <div class="prob" style='width: <%= itens[7].probabilidade %>%; background-color: blue; border-radius: 1rem;'></div>
                            </div><!-- Probability bar -->
                            <span class="bar-name">Qtde</span>
                            <span class="qty">x1</span>
                        </div><!-- item -->
                    </div><!-- Items container -->
                </div><!-- Item preview section -->
            </div>
        </div>
    </main>

    <script>
        document.getElementById("mute_unmute").addEventListener("click", function() {
            var audio = document.getElementById("bgm_teatime");
            audio.volume = 0.45;
            audio.muted = !audio.muted;
            audio.loop = true
            audio.play();

            if(document.getElementById("mute_unmute").innerHTML === '<i class="fa-solid fa-volume-xmark"></i>')
            { document.getElementById("mute_unmute").innerHTML = '<i class="fa-solid fa-volume-high"></i>' }
            else { document.getElementById("mute_unmute").innerHTML = '<i class="fa-solid fa-volume-xmark"></i>' }
        });

        function roulette() {
            // Desativando o botão
            document.getElementById('start').disabled = true;

            // audio area
            let roulette = new Audio('./sfx/roulette.wav');
            let roulette_decided = new Audio('./sfx/roulette_decided.wav');
            let roulette_btn = new Audio('./sfx/roulette_btn_act.wav');
            roulette_btn.play();

            // Toca a música
            roulette.loop = true;
            roulette.play();

            // Itens a renderizar em ordem de sorteio.
            let items = [
                '<img src="./imgs/Curvemastery.webp" alt="" width="45px">',
                '<img src="./imgs/Duostarls.webp" alt="" width="45px">',
                '<img src="./imgs/Duostarluckypangya.webp" alt="" width="45px">',
                '<img src="./imgs/Powerpotion.webp" alt="" width="45px">',
                '<img src="./imgs/g_earing_02.png" alt="" width="60px">',
                '<img src="./imgs/ball_128.png" alt="" width="45px">',
                '<img src="./imgs/item1_48.png" alt="" width="60px">',
                '<img src="./imgs/removedor.png" alt="" width="45px">'
                ];
            let itemIndex = 0;
            
            // Animação dos items
            function animateItemBox() {
                document.getElementById('itemBox').innerHTML = items[itemIndex]; 
                itemIndex = (itemIndex + 1) % items.length;
            }
            let intervalId = setInterval(animateItemBox, 50);
        
            
            /* 
            * Pede pra pangya roulette api gerar um numero do sorteio.
            * Em um cenario real, você faria essa chamada pra API,
            * a mesma iria varrer o banco de dados procurando por tickets na conta
            * Caso confirmado que o player logado tenha mais tickets na conta
            * Ele jogaria uma call pra Pangya Roulette api gerar o numero da sorte e, depois do retorno,
            * Gravar o item ganho no banco de dados. Mas como aqui é teste vamos fazer com numeros ficticios. 
            */
            const opt = {
                method: 'GET',
                headers: { 'Content-Type': 'application/json', }
            };
            fetch(`/api/v1/sort_item`, opt)
                .then((response) => response.json())
                .then(data => {
                    // Após verificar que tem tickets e gerar o meu numero da sorte, continuar.
                    setTimeout(() => {
                        clearInterval(intervalId);
                        document.getElementById('itemBox').innerHTML = items[data.item_sorted]; 
                        roulette.pause();
                        roulette.currentTime = 0;
                        roulette_decided.play();

                        // Fazer o item piscar 5 vezes
                        let blinkTimes = 5;
                        let blinkFunction = function() {
                            if(blinkTimes > 0) {
                                blinkTimes--;
                                $('#itemBox').fadeOut(150).fadeIn(150, blinkFunction);
                            }
                            else
                            {
                                setTimeout(() => {
                                    document.getElementById('start').disabled = false;
                                    alert(`Ganhou o item ${data.item_sorted}`)
                                },120);
                            }
                        };
                        blinkFunction();
                    }, 5000);
                })
                .catch((error) => console.log(error))
        };
    </script>
</body>
</html>